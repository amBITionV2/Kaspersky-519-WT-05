{% extends 'base.html' %}
{% set title = 'Nearby People | DailyHelper' %}
{% block head_extra %}
<style>
.map-container {
  position: relative;
  height: 500px;
  border-radius: var(--border-radius);
  overflow: hidden;
  border: 2px solid var(--border-color);
  background: var(--panel-color);
}

#mappls-map {
  width: 100%;
  height: 100%;
}

.map-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 1000;
  background: white;
  padding: 0.5rem 1rem;
  border-radius: 20px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  font-size: 0.9rem;
  color: var(--text-color);
}

.map-legend {
  position: absolute;
  bottom: 10px;
  right: 10px;
  z-index: 1000;
  background: white;
  padding: 1rem;
  border-radius: var(--border-radius);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  max-width: 200px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.legend-dot.user {
  background: var(--accent-color);
}

.legend-dot.current {
  background: #ef4444;
  border: 2px solid white;
  box-shadow: 0 0 0 2px var(--accent-color);
}

.user-marker {
  background: var(--accent-color);
  color: white;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 600;
  border: 2px solid white;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
  cursor: pointer;
  transition: transform 0.2s ease;
}

.user-marker:hover {
  transform: scale(1.1);
}

.current-location-marker {
  background: #ef4444;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  border: 3px solid white;
  box-shadow: 0 0 0 3px var(--accent-color), 0 2px 5px rgba(0, 0, 0, 0.3);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7), 0 2px 5px rgba(0, 0, 0, 0.3);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(239, 68, 68, 0), 0 2px 5px rgba(0, 0, 0, 0.3);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0), 0 2px 5px rgba(0, 0, 0, 0.3);
  }
}

.map-info-window {
  background: white;
  padding: 1rem;
  border-radius: var(--border-radius);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  max-width: 250px;
  font-size: 0.9rem;
}

.map-info-name {
  font-weight: 600;
  color: var(--text-color);
  margin-bottom: 0.5rem;
}

.map-info-location {
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.map-info-reputation {
  background: var(--accent-color);
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.8rem;
  display: inline-block;
  margin-bottom: 0.5rem;
}

.map-info-skills {
  color: var(--text-muted);
  font-size: 0.8rem;
  margin-bottom: 1rem;
}

.map-info-actions {
  display: flex;
  gap: 0.5rem;
}

.map-info-actions .btn {
  font-size: 0.8rem;
  padding: 0.5rem 1rem;
}

.loading-map {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-muted);
  font-size: 1.1rem;
}

.loading-spinner {
  width: 30px;
  height: 30px;
  border: 3px solid var(--border-color);
  border-top: 3px solid var(--accent-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .map-container {
    height: 400px;
  }

  .map-legend {
    bottom: 5px;
    right: 5px;
    max-width: 150px;
    padding: 0.5rem;
  }

  .legend-item {
    font-size: 0.8rem;
  }
}
</style>
{% endblock %}

{% block content %}
  <section class="card">
    <div class="hero">
      <h2>See Nearby People</h2>
      <p class="muted">Find helpers and requesters near you. Set your latitude/longitude in your profile to enable this feature.</p>
    </div>
    <form method="get" class="nearby-filters">
      <div class="grid grid-3">
        <div class="field">
          <label>Distance radius (km)</label>
          <select class="input" name="radius">
            {% for r in [1,2,5,10,20,50] %}
              <option value="{{ r }}" {% if filters.radius|int == r %}selected{% endif %}>{{ r }} km</option>
            {% endfor %}
          </select>
        </div>
        <div class="field">
          <label>Skills</label>
          <input class="input" type="text" name="skills" value="{{ filters.skills }}" placeholder="e.g., tutoring, first-aid" />
        </div>
        <div class="field">
          <label>Reputation minimum</label>
          <input class="input" type="number" min="0" max="100" step="5" name="rep_min" value="{{ filters.rep_min }}" />
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="submit"><i class="fa-solid fa-filter"></i> Apply</button>
        <a class="btn secondary" href="{{ url_for('nearby') }}">Reset</a>
      </div>
    </form>
  </section>

  <div class="grid grid-2" style="margin-top:1rem;">
    <section class="card">
      <h3>People near you</h3>
      {% if results %}
        <div class="grid-cards">
          {% for r in results %}
            {% set u = r.user %}
            <div class="mp-card">
              <div class="mp-card__head">
                <div class="avatar" {% if u.avatar_url %}style="background-image:url({{ u.avatar_url|tojson }});"{% endif %}></div>
                <div>
                  <strong>{{ u.full_name or u.username }}</strong>
                  <div class="muted" style="font-size:.9rem;">{{ u.location or 'Unknown' }} Â· {{ r.distance }} km away</div>
                </div>
                <div style="margin-left:auto; text-align:right;">
                  <div class="muted">Rep: {{ '%.1f'|format(u.reputation_score or 0) }}</div>
                  {% if u.skills %}<div class="muted" style="max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Skills: {{ u.skills }}</div>{% endif %}
                </div>
              </div>
              <div class="actions">
                <a class="btn" href="{{ url_for('profile_view', username=u.username) }}">View Profile</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No nearby users found with the selected filters.</p>
      {% endif %}
    </section>

    <aside class="card">
      <h3>Interactive Map</h3>
      <div class="map-overlay">
        <i class="fa-solid fa-location-crosshairs"></i>
        Radius: {{ filters.radius }}km
      </div>
      <div class="map-container">
        <div id="mappls-map" class="loading-map">
          <div class="loading-spinner"></div>
          Loading Mappls Map...
        </div>
      </div>
      <div class="map-legend">
        <div class="legend-item">
          <div class="legend-dot current"></div>
          <span>Your Location</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot user"></div>
          <span>Nearby Users</span>
        </div>
      </div>
      <p class="muted" style="margin-top:.5rem;">Interactive map showing nearby users and your current location.</p>
    </aside>
  </div>

  <!-- Mappls SDK -->
  <script src="https://apis.mappls.com/advancedmaps/api/{{ '87e79ea3bd9724db126479ca8be9767c' }}/map_sdk?layer=vector&v=3.0"></script>
  <script>
    let mapplsMap = null;
    let userMarkers = [];
    let currentLocationMarker = null;

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeMap();
    });

    function initializeMap() {
      // Check if current user has location coordinates
      {% if current_user.latitude and current_user.longitude %}
        const centerLat = {{ current_user.latitude }};
        const centerLng = {{ current_user.longitude }};

        // Initialize Mappls map
        mapplsMap = new mappls.Map('mappls-map', {
          center: [centerLat, centerLng],
          zoom: 12,
          zoomControl: true,
          attributionControl: false
        });

        // Add current location marker
        addCurrentLocationMarker(centerLat, centerLng);

        // Add nearby user markers
        addNearbyUserMarkers();

        // Fit map to show all markers
        fitMapToMarkers();
      {% else %}
        // Show message if user hasn't set location
        document.getElementById('mappls-map').innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: var(--text-muted);">
            <i class="fa-solid fa-location-crosshairs" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <h3>Set Your Location</h3>
            <p style="text-align: center; margin-bottom: 1rem;">Please set your latitude and longitude in your profile to see the interactive map.</p>
            <a href="{{ url_for('profile_edit') }}" class="btn">Update Profile</a>
          </div>
        `;
      {% endif %}
    }

    function addCurrentLocationMarker(lat, lng) {
      if (!mapplsMap) return;

      currentLocationMarker = new mappls.Marker({
        map: mapplsMap,
        position: {lat: lat, lng: lng},
        draggable: false,
        icon: {
          url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
            <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
              <circle cx="10" cy="10" r="7" fill="#ef4444" stroke="white" stroke-width="3"/>
            </svg>
          `),
          size: [20, 20],
          anchor: [10, 10]
        }
      });

      userMarkers.push(currentLocationMarker);
    }

    function addNearbyUserMarkers() {
      if (!mapplsMap) return;

      {% if results %}
        {% for r in results %}
          {% set u = r.user %}
          const userLat = {{ u.latitude or 'null' }};
          const userLng = {{ u.longitude or 'null' }};

          if (userLat && userLng) {
            const marker = new mappls.Marker({
              map: mapplsMap,
              position: {lat: userLat, lng: userLng},
              draggable: false,
              icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                  <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="15" cy="15" r="13" fill="#3b82f6" stroke="white" stroke-width="2"/>
                    <text x="15" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">{{ u.username[:1].upper() }}</text>
                  </svg>
                `),
                size: [30, 30],
                anchor: [15, 15]
              }
            });

            // Add click event for user info
            marker.addListener('click', function() {
              showUserInfo('{{ u.username }}', '{{ u.full_name or u.username }}', '{{ u.location or 'Unknown' }}', '{{ "%.1f"|format(u.reputation_score or 0) }}', '{{ u.skills or 'No skills listed' }}');
            });

            userMarkers.push(marker);
          }
        {% endfor %}
      {% endif %}
    }

    function showUserInfo(username, fullName, location, reputation, skills) {
      // Create info window content
      const infoContent = `
        <div class="map-info-window">
          <div class="map-info-name">${fullName}</div>
          <div class="map-info-location">${location}</div>
          <div class="map-info-reputation">Rep: ${reputation}</div>
          <div class="map-info-skills">${skills}</div>
          <div class="map-info-actions">
            <a href="/u/${username}" class="btn" style="font-size: 0.8rem; padding: 0.5rem 1rem;">View Profile</a>
          </div>
        </div>
      `;

      // Show info window on map
      new mappls.InfoWindow({
        map: mapplsMap,
        content: infoContent,
        position: mapplsMap.getCenter()
      }).open(mapplsMap);
    }

    function fitMapToMarkers() {
      if (!mapplsMap || userMarkers.length === 0) return;

      const bounds = new mappls.LatLngBounds();
      userMarkers.forEach(marker => {
        bounds.extend(marker.getPosition());
      });

      mapplsMap.fitBounds(bounds, {padding: 50});
    }

    // Re-initialize map when filters change
    function refreshMap() {
      if (mapplsMap) {
        mapplsMap.remove();
      }
      userMarkers = [];
      initializeMap();
    }
  </script>
{% endblock %}
